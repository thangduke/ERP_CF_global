<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <template id="report_price_calculation_template">
    <t t-call="web.html_container">
      <t t-foreach="docs" t-as="o">
        <t t-call="web.basic_layout">
          <div class="page" style="margin:0; padding:0; font-family:Arial, sans-serif;">

            <!-- HEADER -->
            <table style="width:100%; border:1px solid rgba(0, 0, 0, 0.5); border-collapse:collapse;">
              <tr>
                <td style="width:30%; text-align:center; border-right:1px solid rgba(0, 0, 0, 0.5); vertical-align:middle;">
                  <h1 style="margin:10px; font-weight:700; font-size:20px;">COSTING SHEET</h1>
                </td>
                <td style="width:70%; padding:5px; vertical-align:middle; background-color:#f2f2f2;">
                  <table style="width:100%; border:none;">
                    <tr>
                      <td style="width:20%; border:none; text-align:left; vertical-align:middle; ">
                        <img t-if="o.company_id.logo"
                             t-att-src="'data:image/png;base64,%s' % o.company_id.logo.decode('utf-8')"
                             style="max-height:60px;"/>
                      </td>
                      <td style="width:80%; border:none; padding-left:10px;">
                        <h1 style="font-weight:700; font-size:20px; margin:0; line-height:22px;">
                          <span t-esc="o.company_id.name"/>
                        </h1>
                        <p style="font-size:13px; margin:0; line-height:16px;">
                          <span t-esc="o.company_id.street"/> <span t-esc="o.company_id.street2"/>
                        </p>
                        <p style="font-size:13px; margin:0; line-height:16px;">
                          TEL: <span t-esc="o.company_id.phone"/>
                        </p>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>

            <!-- STYLE & CUSTOMER INFO -->
            <table style="width:100%; border:1px solid rgba(0, 0, 0, 0.5); border-collapse:collapse; margin-top:-1px; font-size:10px;">
              <tr>
                <td style="width:35%; border-right:1px solid rgba(0, 0, 0, 0.5); padding:5px; vertical-align:top;">
                  <strong>Style information</strong>
                  <table style="width:100%; margin-top:5px; border-collapse:collapse;">
                    <tr><td style="font-weight:bold;">Style#</td><td style="font-weight:bold;" ><span t-esc="o.product_code_id.name or ''"/></td></tr>
                    <tr><td>Style(Color, Size)</td><td><span t-esc="o.product_color_size_id.display_name or ''"/></td></tr>
                    <tr><td>Buyer Style#</td><td><span t-esc="o.product_code_id.ean_no or ''"/></td></tr>
                    <tr><td>Style Name</td><td><span t-esc="o.product_code_id.description or ''"/></td></tr>
                  </table>
                </td>

                <td style="width:45%;border-right:1px solid rgba(0, 0, 0, 0.5); padding:5px; vertical-align:top;">
                  <strong>Customer, program, maker</strong>
                  <table style="width:100%; margin-top:5px; border-collapse:collapse;">
                    <tr style="width:25%;"><td>Customer:</td><td><span t-esc="o.customer_id.name_customer or ''"/></td></tr>
                    <tr style="width:25%;"><td>Prg.name</td><td><span t-esc="o.warehouse_order_id.name or ''"/></td></tr>
                    <tr style="width:25%;"><td>Maker#</td><td><span t-esc="o.employee_id.name or ''"/></td></tr>
                    <tr style="width:25%;"><td>Create date</td><td><span t-esc="o.date_calculation.strftime('%d/%m/%Y') if o.date_calculation else ''"/></td></tr>
                  </table>
                </td>

                <td style="width:20%; border-right:1px solid rgba(0, 0, 0, 0.5); text-align:center; vertical-align:top; padding:5px;">
                  <strong>Style image</strong>
                  <t t-if="o.product_code_id.image_128">
                    <br/>
                    <img t-att-src="image_data_uri(o.product_code_id.image_128)"
                         style="max-height:60px; margin-top: 4px;"/>
                  </t>
                </td>
              </tr>
            </table>


            <!-- DANH SÁCH VẬT TƯ THEO MTR_TYPE -->
            <table style="width:100%; border-collapse: collapse; margin-top:8px;">
                <!-- Tiêu đề bảng -->
                <thead style="border:1px solid rgba(0, 0, 0, 0.4); background-color:#f2f2f2;">
                    <tr style="font-size:9px; line-height:18px; height:25px;">
                        <th style="width:10%; text-align:left; padding:2px;">Position</th>
                        <th style="width:8%;  text-align:left; padding:2px;">Mtr#</th>
                        <th style="width:10%; text-align:left; padding:2px;">Mtr Code</th>
                        <th style="width:20%;  text-align:left; padding:2px;">Material name</th>
                        <th style="width:8%; text-align:left; padding:2px;">Dimens.</th>
                        <th style="width:6%;  text-align:left; padding:4px;">Rate</th>
                        <th style="width:8%;  text-align:left; padding:2px;">Color</th>
                        <th style="width:10%;  text-align:left; padding:2px;">Supplier#</th>
                        <th style="width:8%;  text-align:center; padding:2px;">Cons.</th>
                        <th style="width:6%;  text-align:center; padding:2px;">Prc US$</th>
                        <th style="width:6%; text-align:center; padding:2px;">Total US$</th>
                    </tr>
                </thead>

                <tbody style="font-size:9px; line-height:16px;">
                    <tr style="height:5px;"><td colspan="11" style="border:none;"></td></tr>

                    <!-- Lặp qua từng nhóm mtr_type -->
                    <t t-foreach="o.calculation_line_ids.mapped('mtr_type')" t-as="mtype">
                        <!-- Tiêu đề nhóm -->
                        <tr style="font-weight:bold; background-color:#eee; border-bottom:1px solid rgba(0,0,0,0.3);">
                            <td colspan="11" style="border-left:1px solid rgba(0,0,0,0.3); border-right:1px solid rgba(0,0,0,0.3); padding:4px; font-size:11px;">
                                <span t-esc="mtype.name"/>
                            </td>
                        </tr>

                        <!-- Các vật tư thuộc nhóm -->
                        <tr t-foreach="o.calculation_line_ids.filtered(lambda l: l.mtr_type.id == mtype.id)" t-as="line" style="border-bottom:1px solid rgba(0,0,0,0.2);border-left:1px solid rgba(0,0,0,0.3); border-right:1px solid rgba(0,0,0,0.3); height:22px;">
                            <td style="border:none; text-align:left; padding:4px;"><span t-esc="line.position or ''"/></td>
                            <td style="border:none; text-align:left; padding:4px;"><span t-esc="line.name or ''"/></td>
                            <td style="border:none; text-align:left; padding:4px;"><span t-esc="line.mtr_code or ''"/></td>
                            <td style="border:none; text-align:left; padding:4px;"><span t-esc="line.mtr_name or ''"/></td>
                            <td style="border:none; text-align:left; padding:4px;"><span t-esc="line.dimension or ''"/></td>
                            <td style="border:none; text-align:left; padding:4px;"><span t-esc="line.rate or ''"/></td>
                            <td style="border:none; text-align:left; padding:4px;"><span t-esc="line.color_name or ''"/></td>
                            <td style="border:none; text-align:left; padding:4px;"><span t-esc="line.supplier_index or ''"/></td>
                            <td style="border:none; text-align:center; padding:4px;"><span t-esc="'{:.3f}'.format(line.consumption or 0.0)"/></td>
                            <td style="border:none; text-align:center; padding:4px;"><span t-esc="'{:.3f}'.format(line.price or 0.0)"/></td>
                            <td style="border:none; text-align:center; padding:4px;"><span t-esc="'{:.3f}'.format(line.total_price or 0.0)"/></td>
                        </tr>

                        <!-- Subtotal cuối nhóm -->
                        <tr style="font-weight:bold; font-size:11px; line-height:18px; height:25px; background-color:#f9f9f9;border-left:1px solid rgba(0,0,0,0.3); border-right:1px solid rgba(0,0,0,0.3); border-bottom:1px solid rgba(0,0,0,0.3);">
                            <td colspan="11" style="border:none; text-align:right; padding:4px;">
                                <span t-esc="len(o.calculation_line_ids.filtered(lambda l: l.mtr_type.id == mtype.id))"/> item , total
                            </td>
                            <td style="border:none; text-align:right; padding:4px;">
                                <span t-esc="'{:.3f}'.format(sum(l.total_price for l in o.calculation_line_ids if l.mtr_type.id == mtype.id))"/>
                            </td>
                        </tr>
                        <tr><td colspan="11" style="height:8px; border:none;"></td></tr>
                    </t>
                </tbody>
            </table>


            <!-- COST SUMMARY -->
            <h3 style="margin-top:20px; font-size:14px;">COST SUMMARY</h3>
            <table style="width:100%; font-size:11px; border-collapse:collapse;">
            <tr>
                <!-- Cột trái -->
                <td style="width:50%; vertical-align:top; padding-right:10px; padding:5px;">
                <table style="width:100%; border:1px solid rgba(0, 0, 0, 0.5);;">
                    <tr style="height:22px; border:1px solid rgba(0, 0, 0, 0.3); padding:4px;"><td>1. Material cost:</td><td style="text-align:right;"><span t-esc="'{:.2f}'.format(o.material_cost or 0.0)"/> US$</td></tr>
                    <tr style="height:22px; border:1px solid rgba(0, 0, 0, 0.3); padding:4px;"><td>2. Waste (1 x <span t-esc="'{:.2f}'.format(o.waste_percent or 0.0)"/>%):</td><td style="text-align:right;"><span t-esc="'{:.2f}'.format(o.waste or 0.0)"/> US$</td></tr>
                    <tr style="height:22px; border:1px solid rgba(0, 0, 0, 0.3); padding:4px;"><td>3. Finance (1 x <span t-esc="'{:.2f}'.format(o.finance_percent or 0.0)"/>%):</td><td style="text-align:right;"><span t-esc="'{:.2f}'.format(o.finance or 0.0)"/> US$</td></tr>
                    <tr style="height:22px; border:1px solid rgba(0, 0, 0, 0.3); padding:4px; font-weight:bold;"><td>4. Total net (1+2+3):</td><td style="text-align:right;"><span t-esc="'{:.2f}'.format(o.total_net or 0.0)"/> US$</td></tr>
                    <tr style="height:22px; border:1px solid rgba(0, 0, 0, 0.3); padding:4px;"><td>5. CM:</td><td style="text-align:right;"><span t-esc="'{:.2f}'.format(o.cut_make or 0.0)"/> US$</td></tr>
                    <tr style="height:22px; border:1px solid rgba(0, 0, 0, 0.3); padding:4px;"><td>6. Admin (4&amp;5 x <span t-esc="'{:.2f}'.format(o.admin_percent or 0.0)"/>%):</td><td style="text-align:right;"><span t-esc="'{:.2f}'.format(o.admin or 0.0)"/> US$</td></tr>
                    <tr style="height:22px; border:1px solid rgba(0, 0, 0, 0.3); padding:4px;"><td>7. Inspection cost:</td><td style="text-align:right;"><span t-esc="'{:.2f}'.format(o.inspection_cost or 0.0)"/> US$</td></tr>
                </table>
                </td>

                <!-- Cột phải -->
                <td style="width:50%; vertical-align:top; padding-left:10px; padding:5px;">
                <table style="width:100%; border:1px solid rgba(0, 0, 0, 0.5);">
                    <tr style="height:22px; border:1px solid rgba(0, 0, 0, 0.3); padding:4px;"><td>8. Testing cost:</td><td style="text-align:right;"><span t-esc="'{:.2f}'.format(o.test_cost or 0.0)"/> US$</td></tr>
                    <tr style="height:22px; border:1px solid rgba(0, 0, 0, 0.3); padding:4px;"><td>9. Import/Export cost:</td><td style="text-align:right;"><span t-esc="'{:.2f}'.format(o.import_export_cost or 0.0)"/> US$</td></tr>
                    <tr style="height:22px; border:1px solid rgba(0, 0, 0, 0.3); padding:4px;"><td>10. Standard FOB per pc:</td><td style="text-align:right; font-weight:bold;"><span t-esc="'{:.2f}'.format(o.standard_fob or 0.0)"/> US$</td></tr>
                    <tr style="height:22px; border:1px solid rgba(0, 0, 0, 0.3); padding:4px;"><td>11. Surcharge (<span t-esc="'{:.2f}'.format(o.surcharge_percent or 0.0)"/>%):</td><td style="text-align:right;"><span t-esc="'{:.2f}'.format(o.surcharge or 0.0)"/> US$</td></tr>
                    <tr style="height:22px; border:1px solid rgba(0, 0, 0, 0.3); padding:4px;"><td>12. Extra cost per pc:</td><td style="text-align:right;"><span t-esc="'{:.2f}'.format(o.extra_cost or 0.0)"/> US$</td></tr>
                    <tr style="height:22px; border:1px solid rgba(0, 0, 0, 0.3); padding:4px;"><td>13. Final FOB (10+11+12):</td><td style="text-align:right; font-weight:bold;"><span t-esc="'{:.2f}'.format(o.final_fob or 0.0)"/> US$</td></tr>
                    <tr style="height:22px; border:1px solid rgba(0, 0, 0, 0.3); padding:4px;"><td>14. Agreed FOB per pc:</td><td style="text-align:right; font-weight:bold;"><span t-esc="'{:.2f}'.format(o.agreed_fob or 0.0)"/> US$</td></tr>
                </table>
                </td>
            </tr>
            </table>

            <!-- FOOTER -->
            <div class="footer">
                <div style="width:100%; font-size:12px; border-top:1px solid #000; padding-top:5px; margin-top:10px;">
                Costing sheet of style#: <span t-esc="o.product_code_id.name"/> - Page <span class="page"/> / <span class="topage"/>
                </div>
            </div>
          </div>
        </t>
      </t>
    </t>
  </template>
</odoo>